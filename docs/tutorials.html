

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorials &mdash; btk 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="_static/thebelab.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="BlendingToolKit API" href="src/btk.html" />
    <link rel="prev" title="User Guide" href="user_guide.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> btk
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="catalog.html">Input Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#intro-notebook">Intro notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial">Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drawing-some-blends">Drawing some blends</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#catalog">Catalog</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sampling-function">Sampling Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#survey">Survey</a></li>
<li class="toctree-l4"><a class="reference internal" href="#drawing-the-blends">Drawing the blends</a></li>
<li class="toctree-l4"><a class="reference internal" href="#measurement">Measurement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metrics">Metrics</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-cosmos-galaxies">Using COSMOS galaxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#galsim-hub-tutorial">Galsim_Hub tutorial</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="src/btk.html">BlendingToolKit API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">btk</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Tutorials</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorials.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorials">
<h1>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h1>
<p>The following jupyter notebooks are included in the <cite>notebooks/</cite> directory:</p>
<div class="section" id="intro-notebook">
<h2>Intro notebook<a class="headerlink" href="#intro-notebook" title="Permalink to this headline">¶</a></h2>
<p>This <a class="reference external" href="https://github.com/LSSTDESC/BlendingToolKit/blob/main/notebooks/intro.ipynb">notebook</a> shows how btk can be used to generate images of multi-band blend scenes, along with isolated object images – i.e., PSF-convolved object images are drawn both in isolation and in the blend scene for each band. You can find it retranscribed in the next section or access it normally via the link (necessary for interactivity).</p>
</div>
<div class="section" id="tutorial">
<h2>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>Importing the relevant packages</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">btk</span>
<span class="kn">import</span> <span class="nn">btk.plot_utils</span>
<span class="kn">import</span> <span class="nn">btk.survey</span>
<span class="kn">import</span> <span class="nn">btk.sampling_functions</span>
<span class="kn">import</span> <span class="nn">btk.catalog</span>
<span class="kn">import</span> <span class="nn">btk.draw_blends</span>
<span class="kn">import</span> <span class="nn">astropy.table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</div>
<div class="section" id="drawing-some-blends">
<h3>Drawing some blends<a class="headerlink" href="#drawing-some-blends" title="Permalink to this headline">¶</a></h3>
<p>We will first explore the image generation part of BTK. We need to provide 3 main elements : the catalog, a sampling function and a survey.</p>
<div class="section" id="catalog">
<h4>Catalog<a class="headerlink" href="#catalog" title="Permalink to this headline">¶</a></h4>
<p>BTK uses a wrapper class for the actual catalog object, to get a standardized input for the generator. Currently BTK supports two kind of catalogs : Catsim-like catalogs and the COSMOS catalog (as provided with Galsim). Both have their own implementation of the Catalog class ; we will only use the Catsim one here. You can easily import the catalog from a FITS file using the <cite>from_file</cite> method as demonstrated here with our example catalog.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">catalog_name</span> <span class="o">=</span> <span class="s2">&quot;../data/sample_input_catalog.fits&quot;</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">CatsimCatalog</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">catalog_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>It is also possible to instantiate the class by giving it the catalog directly ; the <cite>from_file</cite> method is merely a shortcut.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">catalog_name</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;fits&quot;</span> <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span> <span class="k">else</span> <span class="s2">&quot;ascii.basic&quot;</span>
<span class="n">raw_catalog</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">catalog_name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">CatsimCatalog</span><span class="p">(</span><span class="n">raw_catalog</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>When the Catalog object is created, it creates internally a <cite>table</cite> attribute containing a modified table from the input, which will be used in the rest of the code.</p>
</div>
<div class="section" id="sampling-function">
<h4>Sampling Function<a class="headerlink" href="#sampling-function" title="Permalink to this headline">¶</a></h4>
<p>The sampling function is an object which is used to determine the informations about the blends, eg which galaxies are drawn, with what shifts, … This is achieved using the <cite>SamplingFunction</cite> class, which is callable like a function, taking as argument the <cite>Catalog.table</cite> and returning modified selected entries corresponding to the galaxies being drawn. For this tutorial, we will use the default sampling function, which can be instantiated like this :</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stamp_size</span> <span class="o">=</span> <span class="mf">24.0</span>  <span class="c1"># Size of the stamp, in arcseconds</span>
<span class="n">max_number</span> <span class="o">=</span> <span class="mi">3</span>     <span class="c1"># Maximum number of galaxies in a blend</span>
<span class="n">max_shift</span> <span class="o">=</span> <span class="mf">3.0</span>    <span class="c1"># Maximum shift of the galaxies, in arcseconds</span>
<span class="n">sampling_function</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">sampling_functions</span><span class="o">.</span><span class="n">DefaultSampling</span><span class="p">(</span><span class="n">max_number</span><span class="o">=</span><span class="n">max_number</span><span class="p">,</span> <span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">,</span> <span class="n">maxshift</span><span class="o">=</span><span class="n">max_shift</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>As a reference, here is the code for this sampling function.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DefaultSampling</span><span class="p">(</span><span class="n">btk</span><span class="o">.</span><span class="n">sampling_functions</span><span class="o">.</span><span class="n">SamplingFunction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default sampling function used for producing blend tables.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stamp_size</span><span class="o">=</span><span class="mf">24.0</span><span class="p">,</span> <span class="n">maxshift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            max_number (int): Defined in parent class</span>
<span class="sd">            stamp_size (float): Size of the desired stamp.</span>
<span class="sd">            maxshift (float): Magnitude of maximum value of shift. If None then it</span>
<span class="sd">                             is set as one-tenth the stamp size. (in arcseconds)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_number</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">=</span> <span class="n">stamp_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxshift</span> <span class="o">=</span> <span class="n">maxshift</span> <span class="k">if</span> <span class="n">maxshift</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">/</span> <span class="mf">10.0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compatible_catalogs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;CatsimCatalog&quot;</span><span class="p">,</span> <span class="s2">&quot;CosmosCatalog&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Applies default sampling to the input CatSim-like catalog and returns an</span>
<span class="sd">        astropy table with entries corresponding to a blend centered close to postage</span>
<span class="sd">        stamp center.</span>

<span class="sd">        Function selects entries from input table that are brighter than 25.3 mag</span>
<span class="sd">        in the i band. Number of objects per blend is set at a random integer</span>
<span class="sd">        between 1 and Args.max_number. The blend table is then randomly sampled</span>
<span class="sd">        entries from the table after selection cuts. The centers are randomly</span>
<span class="sd">        distributed within 1/10th of the stamp size. Here even though the galaxies</span>
<span class="sd">        are sampled from a CatSim catalog, their spatial location are not</span>
<span class="sd">        representative of real blends.</span>

<span class="sd">        Args:</span>
<span class="sd">            table (astropy.table): Table containing entries corresponding to galaxies</span>
<span class="sd">                                   from which to sample.</span>
<span class="sd">            shifts (list): Contains arbitrary shifts to be applied instead of random ones.</span>
<span class="sd">                           Should of the form [x_peak,y_peak] where x_peak and y_peak are the lists</span>
<span class="sd">                           containing the x and y shifts.</span>
<span class="sd">            indexes (list): Contains the indexes of the galaxies to use.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Astropy.table with entries corresponding to one blend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_of_objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">(</span><span class="n">q</span><span class="p">,)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ref_mag&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">25.3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">indexes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blend_table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">number_of_objects</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blend_table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
        <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_peak</span><span class="p">,</span> <span class="n">y_peak</span> <span class="o">=</span> <span class="n">_get_random_center_shift</span><span class="p">(</span><span class="n">number_of_objects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxshift</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_peak</span><span class="p">,</span> <span class="n">y_peak</span> <span class="o">=</span> <span class="n">shifts</span>
        <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x_peak</span>
        <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y_peak</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Object center lies outside the stamp&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blend_table</span>
</pre></div>
</div>
<p>You can see that this function chooses random galaxies (after applying a magnitude cut), computes random shifts for the galaxies and returns the entries from the table, adding two columns corresponding to the shifts. You may write more complex sampling functions if you wish to have more control over how the galaxies are drawn ; there are some other examples in the <cite>btk.sampling_functions</cite> file.</p>
</div>
<div class="section" id="survey">
<h4>Survey<a class="headerlink" href="#survey" title="Permalink to this headline">¶</a></h4>
<p>The BTK Survey object defines the observing conditions relative to a survey. It is based on the named tuple class, and contains various parameters (eg pixel scale), including a list of Filter objects. The Filter class is also based on a named tuple, and contains information concerning a specific filter in the survey (eg exposition time). Numerous surveys are already implemented in BTK ; we will import the Rubin one for this tutorial.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">btk.survey</span> <span class="kn">import</span> <span class="n">Rubin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>You may want to define your own survey if you wish to modify some parameters or use a survey which is not implemented in BTK. We advise you to take the code of an existing survey and modify it to your convenience. Here is the one for Rubin</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">btk.survey</span> <span class="kn">import</span> <span class="n">get_psf</span>
<span class="n">_central_wavelength</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="mf">3592.13</span><span class="p">,</span>
    <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="mf">4789.98</span><span class="p">,</span>
    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mf">6199.52</span><span class="p">,</span>
    <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="mf">7528.51</span><span class="p">,</span>
    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">8689.83</span><span class="p">,</span>
    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">9674.05</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">Rubin</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Survey</span><span class="p">(</span>
    <span class="s2">&quot;LSST&quot;</span><span class="p">,</span>
    <span class="n">pixel_scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
    <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
    <span class="n">airmass</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">zeropoint_airmass</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.703</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">18.6</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">4800</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">10.58</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.138</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.725</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">19.6</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">4800</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">22.68</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.043</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.748</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">20.5</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">5520</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">32.36</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.781</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">21.2</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">5520</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">43.70</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.814</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">22.3</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">2400</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">50.70</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.163</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.859</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">22.9</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">1680</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">9.16</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.451</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Most attributes should be pretty straightforward to modify ; please take a look at the documentation for a more substantial description of the attributes. The <cite>psf</cite> attribute deserves an additionnal explanation : it corresponds to the PSF for each filter. It can be provided either directly as a Galsim model (eg <cite>galsim.Kolmogorov(fwhm=1.5)</cite>) or as a function returning a Galsim model, for randomization purposes. Example :</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_psf</span><span class="p">():</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">1.7</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">galsim</span><span class="o">.</span><span class="n">Kolmogorov</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>You may want to use a function taking an argument to avoid rewriting the function for each filter ; we advise using lambda functions to achieve this, eg <cite>get_u_psf = lambda : get_custom_psf(u_band_argument)</cite>.
Finally, you can use the default function <cite>get_psf</cite> as demonstrated in the Rubin Survey, to get a complex (not random) PSF, or use the function <cite>get_psf_from_file(psf_dir, pixel_scale)</cite> to import a PSF from a FITS file (randomly if there are more than one file in the directory provided).</p>
</div>
<div class="section" id="drawing-the-blends">
<h4>Drawing the blends<a class="headerlink" href="#drawing-the-blends" title="Permalink to this headline">¶</a></h4>
<p>Now that we have all the objects at our disposal, we can create the DrawBlendsGenerator. This object is a python generator, meaning it can be called with <cite>next(generator)</cite> to generate a new batch. It is again declined for Catsim and COSMOS, and we will use the Catsim one here. We suggest you refer to the documentation for information on the additionnal parameters here.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">draw_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">draw_blends</span><span class="o">.</span><span class="n">CatsimGenerator</span><span class="p">(</span>
    <span class="n">catalog</span><span class="p">,</span>
    <span class="n">sampling_function</span><span class="p">,</span>
    <span class="p">[</span><span class="n">Rubin</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">,</span>
    <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">add_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<dl class="simple">
<dt>The results from the <cite>next</cite> call are stored in the dictionnary ; the keys are :</dt><dd><ul class="simple">
<li><p><cite>blend_images</cite> for the actual images (as a (batch_size,stamp_size,stamp_size,len(survey.filters))-sized numpy array )</p></li>
<li><p><cite>isolated_images</cite> for the isolated images (as a (batch_size,sampling_function.max_number,stamp_size,stamp_size,len(survey.filters))-sized numpy array )</p></li>
<li><p><cite>blend_list</cite> for the blend information (as a list of astropy tables corresponding to the output of the sampling function for each blend)</p></li>
<li><p><cite>psf</cite> for the PSF (as a list of Galsim object)</p></li>
<li><p><cite>wcs</cite> for the World Coordinate System corresponding to the images (as a list of astropy.wcs.WCS objects)</p></li>
</ul>
</dd>
</dl>
<p>Please note that several surveys can be provided as a list to the generator. In that case, each of the entry will contain a dictionnary indexed by the surveys, which in turn contains the results described as above (you would access it with <cite>batch[‘blend_images’][‘LSST’]</cite> for instance.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">draw_generator</span><span class="p">)</span>
<span class="n">blend_images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_images&#39;</span><span class="p">]</span>
<span class="n">blend_list</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_list&#39;</span><span class="p">]</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_blends</span><span class="p">(</span><span class="n">blend_images</span><span class="p">,</span> <span class="n">blend_list</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">90</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_7_0.png" src="_images/tutorials_7_0.png" />
<img alt="_images/tutorials_7_1.png" src="_images/tutorials_7_1.png" />
<img alt="_images/tutorials_7_2.png" src="_images/tutorials_7_2.png" />
<img alt="_images/tutorials_7_3.png" src="_images/tutorials_7_3.png" />
<img alt="_images/tutorials_7_4.png" src="_images/tutorials_7_4.png" />
<img alt="_images/tutorials_7_5.png" src="_images/tutorials_7_5.png" />
<img alt="_images/tutorials_7_6.png" src="_images/tutorials_7_6.png" />
<img alt="_images/tutorials_7_7.png" src="_images/tutorials_7_7.png" />
</div>
</div>
</div>
<div class="section" id="measurement">
<h4>Measurement<a class="headerlink" href="#measurement" title="Permalink to this headline">¶</a></h4>
<p>Now that we have some images, we can carry on with the measurements. What we call measurements in BTK is one of the three main targets of deblending : detections, segmentations and deblended images. You can use BTK to directly carry out the measurements on the generated data. To do this, you need to define a measure function.
The measure function is a regular function with two positional arguments : <cite>batch</cite> and <cite>idx</cite>. Batch is the direct output of a <cite>DrawBlendsGenerator</cite>, and <cite>idx</cite> is the index of the blend on which the measurements should be done. It also takes an arbitrary number of keyword arguments via <cite>**kwargs</cite>. Here is an example of what the function looks like for SEP (python implementation of Source Extractor).</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sep_measure</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">channels_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Return detection, segmentation and deblending information with SEP.</span>

<span class="sd">  NOTE: This function does not support the multi-resolution feature.</span>

<span class="sd">  Args:</span>
<span class="sd">      batch (dict): Output of DrawBlendsGenerator object&#39;s `__next__` method.</span>
<span class="sd">      idx (int): Index number of blend scene in the batch to preform</span>
<span class="sd">          measurement on.</span>

<span class="sd">  Returns:</span>
<span class="sd">      dict with the centers of sources detected by SEP detection algorithm.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;blend_images&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function does not support the multi-resolution feature.&quot;</span><span class="p">)</span>

  <span class="n">image</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;blend_images&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
  <span class="n">stamp_size</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># true for both &#39;NCHW&#39; or &#39;NHWC&#39; formats.</span>
  <span class="n">channel_indx</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">channels_last</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">coadd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">channel_indx</span><span class="p">)</span>  <span class="c1"># Smallest dimension is the channels</span>
  <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">coadd</span><span class="p">)</span>
  <span class="c1"># Here the 1.5 value corresponds to a 1.5 sigma threshold for detection against noise.</span>
  <span class="n">catalog</span><span class="p">,</span> <span class="n">segmentation</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">coadd</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">bkg</span><span class="o">.</span><span class="n">globalrms</span><span class="p">,</span> <span class="n">segmentation_map</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">n_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>
  <span class="n">segmentation_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_objects</span><span class="p">,</span> <span class="n">stamp_size</span><span class="p">,</span> <span class="n">stamp_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
  <span class="n">deblended_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_objects</span><span class="p">,</span> <span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_objects</span><span class="p">):</span>
      <span class="n">seg_i</span> <span class="o">=</span> <span class="n">segmentation</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">segmentation_exp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_i</span>
      <span class="n">seg_i_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">stamp_size</span><span class="p">,</span> <span class="n">stamp_size</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
          <span class="n">seg_i_reshaped</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_i</span>
      <span class="n">seg_i_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">seg_i_reshaped</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
      <span class="n">deblended_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span> <span class="n">seg_i_reshaped</span>

  <span class="n">t</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">()</span>
  <span class="n">t</span><span class="p">[</span><span class="s2">&quot;x_peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
  <span class="n">t</span><span class="p">[</span><span class="s2">&quot;y_peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="s2">&quot;catalog&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
      <span class="s2">&quot;segmentation&quot;</span><span class="p">:</span> <span class="n">segmentation_exp</span><span class="p">,</span>
      <span class="s2">&quot;deblended_images&quot;</span><span class="p">:</span> <span class="n">deblended_images</span><span class="p">,</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>The function is not required to output all three measurements, only the catalog containing the detections is mandatory. Once the measure function is defined, it can be given to a <cite>MeasureGenerator</cite> together with the <cite>DrawBlendsGenerator</cite> from the previous step.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meas_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">MeasureGenerator</span><span class="p">(</span><span class="n">btk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">sep_measure</span><span class="p">,</span><span class="n">draw_generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>The results returned by the <cite>MeasureGenerator`are both the results from the `DrawBlendsGenerator</cite> and the measures, as a dictionnary with the same keys as the measure function output but containing a list with the results from all the blends.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">blend_results</span><span class="p">,</span><span class="n">meas_results</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">meas_generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</div>
<div class="section" id="metrics">
<h4>Metrics<a class="headerlink" href="#metrics" title="Permalink to this headline">¶</a></h4>
<p>Finally, now that we have the measurements, we can compute metrics to evaluate the performance of those measurements. This is done using a <cite>MetricsGenerator</cite>, which takes a <cite>MeasureGenerator</cite> as an input, as well as a handful of parameters. It will match the true galaxies with the detected galaxies and compute metrics evaluating the quality of the detection (precision, recall, F1 score), the segmentation (Intersection over Union) and the reconstruction of the galaxy images (Mean Square Residual, Peak Signal to Noise Ratio, Structure Similarity Index, error on the target measures). You can find more details on those metrics on the page of the metrics module in the documentation.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">btk.metrics</span>
<span class="kn">import</span> <span class="nn">btk.plot_utils</span>

<span class="n">metrics_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MetricsGenerator</span><span class="p">(</span><span class="n">meas_generator</span><span class="p">,</span><span class="n">use_metrics</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;detection&quot;</span><span class="p">,</span><span class="s2">&quot;segmentation&quot;</span><span class="p">,</span><span class="s2">&quot;reconstruction&quot;</span><span class="p">),</span>
                                                 <span class="n">target_meas</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ellipticity&quot;</span><span class="p">:</span><span class="n">btk</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">meas_ksb_ellipticity</span><span class="p">})</span>
<span class="n">blend_results</span><span class="p">,</span><span class="n">meas_results</span><span class="p">,</span><span class="n">results</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">metrics_generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>Unphysical situation: galaxy convolved with PSF is smaller than PSF!

Error: NaN in calculation of adaptive moments

Error: adaptive moment failed

</pre></div>
</div>
</div>
</div>
<p>Once we got the results, we can plot them using functions found in the plot_utils module. While you can access all the raw data with the keys “detection”, “segmentation” and “reconstruction”, you can directly access all the segmentation and reconstruction metrics with the “galaxy_summary” key, which contains an astropy Table with all galaxies from all blends and the associated parameters and metrics.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gal_summary</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;galaxy_summary&quot;</span><span class="p">][</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;galaxy_summary&quot;</span><span class="p">][</span><span class="s2">&quot;detected&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span>
<span class="n">msr</span> <span class="o">=</span> <span class="n">gal_summary</span><span class="p">[</span><span class="s2">&quot;msr&quot;</span><span class="p">]</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">gal_summary</span><span class="p">[</span><span class="s2">&quot;distance_closest_galaxy&quot;</span><span class="p">]</span>
<span class="n">dist_detect</span> <span class="o">=</span> <span class="n">gal_summary</span><span class="p">[</span><span class="s2">&quot;distance_detection&quot;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">),(</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_metrics_distribution</span><span class="p">(</span><span class="n">msr</span><span class="p">,</span><span class="s2">&quot;msr&quot;</span><span class="p">,</span><span class="n">ax1</span><span class="p">,</span><span class="n">upper_quantile</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_metrics_distribution</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="s2">&quot;Distance to the closest galaxy&quot;</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_metrics_correlation</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">msr</span><span class="p">,</span><span class="s2">&quot;Distance to the closest galaxy&quot;</span><span class="p">,</span><span class="s2">&quot;msr&quot;</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">upper_quantile</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;heatmap&#39;</span><span class="p">)</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_metrics_correlation</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">dist_detect</span><span class="p">,</span><span class="s2">&quot;Distance to the closest galaxy&quot;</span><span class="p">,</span><span class="s2">&quot;Distance detection&quot;</span><span class="p">,</span><span class="n">ax4</span><span class="p">,</span><span class="n">upper_quantile</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_efficiency_matrix</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;detection&quot;</span><span class="p">][</span><span class="s2">&quot;eff_matrix&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_12_0.png" src="_images/tutorials_12_0.png" />
<img alt="_images/tutorials_12_1.png" src="_images/tutorials_12_1.png" />
</div>
</div>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gal_summary_filtered</span> <span class="o">=</span> <span class="n">gal_summary</span><span class="p">[</span><span class="n">gal_summary</span><span class="p">[</span><span class="s2">&quot;ellipticity0_true&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.0</span><span class="p">]</span>
<span class="n">gal_summary_filtered</span> <span class="o">=</span> <span class="n">gal_summary_filtered</span><span class="p">[</span><span class="n">gal_summary_filtered</span><span class="p">[</span><span class="s2">&quot;ellipticity0_true&quot;</span><span class="p">]</span><span class="o">&gt;-</span><span class="mf">1.0</span><span class="p">]</span>
<span class="n">gal_summary_filtered</span> <span class="o">=</span> <span class="n">gal_summary_filtered</span><span class="p">[</span><span class="n">gal_summary_filtered</span><span class="p">[</span><span class="s2">&quot;ellipticity0&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.0</span><span class="p">]</span>
<span class="n">gal_summary_filtered</span> <span class="o">=</span> <span class="n">gal_summary_filtered</span><span class="p">[</span><span class="n">gal_summary_filtered</span><span class="p">[</span><span class="s2">&quot;ellipticity0&quot;</span><span class="p">]</span><span class="o">&gt;-</span><span class="mf">1.0</span><span class="p">]</span>
<span class="n">e1</span> <span class="o">=</span> <span class="n">gal_summary_filtered</span><span class="p">[</span><span class="s2">&quot;ellipticity0&quot;</span><span class="p">]</span>
<span class="n">e1_true</span> <span class="o">=</span> <span class="n">gal_summary_filtered</span><span class="p">[</span><span class="s2">&quot;ellipticity0_true&quot;</span><span class="p">]</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_metrics_correlation</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="n">e1_true</span><span class="p">,</span><span class="s2">&quot;e1&quot;</span><span class="p">,</span><span class="s2">&quot;e1_true&quot;</span><span class="p">,</span><span class="n">upper_quantile</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;truth&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_13_0.png" src="_images/tutorials_13_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="using-cosmos-galaxies">
<h2>Using COSMOS galaxies<a class="headerlink" href="#using-cosmos-galaxies" title="Permalink to this headline">¶</a></h2>
<p>We will now focus on generating image using galaxies from the COSMOS catalog. You will find that generating images with COSMOS is very similar to generating images with Catsim. Let’s start with the catalog and sampling function. Here we use a small sample of the real COSMOS catalog ; feel free to fill in the correct path if you have the complete catalog on your computer.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COSMOS_CATALOG_PATHS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;../data/cosmos/real_galaxy_catalog_23.5_example.fits&quot;</span><span class="p">,</span>
    <span class="s2">&quot;../data/cosmos/real_galaxy_catalog_23.5_example_fits.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">stamp_size</span> <span class="o">=</span> <span class="mf">24.0</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">CosmosCatalog</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">COSMOS_CATALOG_PATHS</span><span class="p">)</span>
<span class="n">sampling_function</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">sampling_functions</span><span class="o">.</span><span class="n">DefaultSampling</span><span class="p">(</span><span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>We can now create the corresponding instance of DrawBlendsGenerator. There is an important caveat here : as in the other tutorial, we use the Rubin survey. However, the COSMOS catalog only contains images from the f814w band ; when using other bands, the image is only rescaled to get the right flux. Moreover, at the time the flux will not be accurate as we do not have the SED for COSMOS galaxies, meaning that we cannot recover the correct magnitude in other bands than f814w ; the flux is thus computed using the magnitude in that band and the survey parameters provided. We are currently working on getting a more realistic flux.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">draw_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">draw_blends</span><span class="o">.</span><span class="n">CosmosGenerator</span><span class="p">(</span>
        <span class="n">catalog</span><span class="p">,</span>
        <span class="n">sampling_function</span><span class="p">,</span>
        <span class="p">[</span><span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Rubin</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">,</span>
        <span class="n">cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">add_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">meas_bands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">],</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">draw_generator</span><span class="p">)</span>
<span class="n">blend_images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_images&#39;</span><span class="p">]</span>
<span class="n">blend_list</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_list&#39;</span><span class="p">]</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_blends</span><span class="p">(</span><span class="n">blend_images</span><span class="p">,</span> <span class="n">blend_list</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">90</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_16_0.png" src="_images/tutorials_16_0.png" />
<img alt="_images/tutorials_16_1.png" src="_images/tutorials_16_1.png" />
<img alt="_images/tutorials_16_2.png" src="_images/tutorials_16_2.png" />
<img alt="_images/tutorials_16_3.png" src="_images/tutorials_16_3.png" />
<img alt="_images/tutorials_16_4.png" src="_images/tutorials_16_4.png" />
<img alt="_images/tutorials_16_5.png" src="_images/tutorials_16_5.png" />
<img alt="_images/tutorials_16_6.png" src="_images/tutorials_16_6.png" />
<img alt="_images/tutorials_16_7.png" src="_images/tutorials_16_7.png" />
</div>
</div>
</div>
<div class="section" id="galsim-hub-tutorial">
<h2>Galsim_Hub tutorial<a class="headerlink" href="#galsim-hub-tutorial" title="Permalink to this headline">¶</a></h2>
<p>BTK supports galaxy image generation with galsim_hub ; please refer to <span class="xref std std-ref">this page</span> for more details on galsim_hub. The steps for using the galsim_hub generation are very similar to those from the previous section. Before starting this tutorial, you must install galsim_hub, which can be done using pip. You can find a notebook version of this tutorial in the notebooks folder.</p>
<p>First, you should use the <cite>CosmosCatalog</cite> catalog instead of the Catsim one. While galsim_hub only require parameters for the image generation, we have chosen to use COSMOS as the source of those parameters so as to get a realistic distribution of those parameters. We have included a small sample of the catalog in BTK, and advise you to download the full catalog (see:ref:<cite>COSMOS</cite>) for better results.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COSMOS_CATALOG_PATHS</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s2">&quot;../data/cosmos/real_galaxy_catalog_23.5_example.fits&quot;</span><span class="p">,</span>
  <span class="s2">&quot;../data/cosmos/real_galaxy_catalog_23.5_example_fits.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">CosmosCatalog</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">COSMOS_CATALOG_PATHS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>We then instantiate the sampling function ; you should use the one specific for galsim_hub, which includes a cut on the size of the galaxies, as artifacts tend to appear when trying to generate galaxies which are too big.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stamp_size</span> <span class="o">=</span> <span class="mf">24.0</span>
<span class="n">sampling_function</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">sampling_functions</span><span class="o">.</span><span class="n">DefaultSamplingGalsimHub</span><span class="p">(</span><span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>Then we can instantiate the <cite>DrawBlendsGenerator</cite> with the survey of your choice. Please bear in mind that while BTK will draw the images in any band you desire, galsim_hub does not generate a SED for the galaxy ; this means that the magnitude will be inacurrate in any other band than the one generated by the galsim_hub model you use (by default <cite>“hub:Lanusse2020”</cite>).</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">draw_generator</span><span class="p">)</span>
<span class="n">blend_images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_images&#39;</span><span class="p">]</span>
<span class="n">blend_list</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_list&#39;</span><span class="p">]</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_blends</span><span class="p">(</span><span class="n">blend_images</span><span class="p">,</span> <span class="n">blend_list</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">90</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_19_0.png" src="_images/tutorials_19_0.png" />
<img alt="_images/tutorials_19_1.png" src="_images/tutorials_19_1.png" />
<img alt="_images/tutorials_19_2.png" src="_images/tutorials_19_2.png" />
<img alt="_images/tutorials_19_3.png" src="_images/tutorials_19_3.png" />
<img alt="_images/tutorials_19_4.png" src="_images/tutorials_19_4.png" />
<img alt="_images/tutorials_19_5.png" src="_images/tutorials_19_5.png" />
<img alt="_images/tutorials_19_6.png" src="_images/tutorials_19_6.png" />
<img alt="_images/tutorials_19_7.png" src="_images/tutorials_19_7.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="src/btk.html" class="btn btn-neutral float-right" title="BlendingToolKit API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="user_guide.html" class="btn btn-neutral float-left" title="User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, btk developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>