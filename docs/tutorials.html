

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorials &mdash; btk 0.9.3 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="_static/thebelab.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Command Line Interface" href="cli.html" />
    <link rel="prev" title="User Guide" href="user_guide.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> btk
          

          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="catalog.html">Input Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#intro-notebook">Intro notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial">Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reproducibility">Reproducibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drawing-some-blends">Drawing some blends</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#catalog">Catalog</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sampling-function">Sampling Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#survey">Survey</a></li>
<li class="toctree-l4"><a class="reference internal" href="#drawing-the-blends">Drawing the blends</a></li>
<li class="toctree-l4"><a class="reference internal" href="#measurement">Measurement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metrics">Metrics</a></li>
<li class="toctree-l4"><a class="reference internal" href="#saving-the-results">Saving the results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-cosmos-galaxies">Using COSMOS galaxies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-different-magnitudes-for-each-band">Using different magnitudes for each band</a></li>
<li class="toctree-l3"><a class="reference internal" href="#more-information-about-the-cosmos-catalog">More information about the COSMOS catalog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#galsim-hub-tutorial">Galsim_Hub tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scarlet-implementation">SCARLET implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-features">Advanced features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Interface</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="src/btk.html">BlendingToolKit API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">btk</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Tutorials</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorials.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorials">
<h1>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h1>
<p>The following jupyter notebooks are included in the <cite>notebooks/</cite> directory:</p>
<div class="section" id="intro-notebook">
<h2>Intro notebook<a class="headerlink" href="#intro-notebook" title="Permalink to this headline">¶</a></h2>
<p>This <a class="reference external" href="https://github.com/LSSTDESC/BlendingToolKit/blob/main/notebooks/00-intro.ipynb">notebook</a> shows how btk can be used to generate images of multi-band blend scenes, along with isolated object images – i.e., PSF-convolved object images are drawn both in isolation and in the blend scene for each band. You can find it retranscribed in the next section or access it normally via the link (for interactivity).</p>
</div>
<div class="section" id="tutorial">
<h2>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>Importing the relevant packages</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">btk</span>
<span class="kn">import</span> <span class="nn">btk.plot_utils</span>
<span class="kn">import</span> <span class="nn">btk.survey</span>
<span class="kn">import</span> <span class="nn">btk.sampling_functions</span>
<span class="kn">import</span> <span class="nn">btk.catalog</span>
<span class="kn">import</span> <span class="nn">btk.draw_blends</span>
<span class="kn">import</span> <span class="nn">astropy.table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</div>
<div class="section" id="reproducibility">
<h3>Reproducibility<a class="headerlink" href="#reproducibility" title="Permalink to this headline">¶</a></h3>
<p>The following cell contains the seed use to generate reproducible random realizations of BTK output. Using the same seed in BTK for <strong>both the sampling function and draw blend generator</strong> (more info below) guarantees the galaxy images and parameters produced will be the same, even across different systems.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">btk</span> <span class="kn">import</span> <span class="n">DEFAULT_SEED</span>
<span class="n">seed</span> <span class="o">=</span> <span class="n">DEFAULT_SEED</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>Every object in BTK that needs a seed uses <cite>DEFAULT_SEED</cite> implicitly. In this tutorial we explicitly show how this seed is passed in and which objects needs a seed. However, we omit it in the other tutorials.</p>
</div>
<div class="section" id="drawing-some-blends">
<h3>Drawing some blends<a class="headerlink" href="#drawing-some-blends" title="Permalink to this headline">¶</a></h3>
<p>We will first explore the image generation part of BTK. We need to provide 3 main elements: the catalog, a sampling function and a survey.</p>
<div class="section" id="catalog">
<h4>Catalog<a class="headerlink" href="#catalog" title="Permalink to this headline">¶</a></h4>
<p>BTK uses a wrapper class for the actual catalog object, to get a standardized input for the generator. Currently BTK supports two kind of catalogs: Catsim-like catalogs and the COSMOS catalog (as provided with Galsim). Both have their own implementation of the <code class="docutils literal notranslate"><span class="pre">Catalog</span></code> class; we will only use the Catsim one here. You can easily import the catalog from a FITS file using the <code class="docutils literal notranslate"><span class="pre">from_file</span></code> method as demonstrated here with our example catalog.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">catalog_name</span> <span class="o">=</span> <span class="s2">&quot;../data/sample_input_catalog.fits&quot;</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">CatsimCatalog</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">catalog_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>It is also possible to instantiate the class by giving it the catalog directly; the <code class="docutils literal notranslate"><span class="pre">from_file</span></code> method is just a convenient shortcut.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">catalog_name</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;fits&quot;</span> <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span> <span class="k">else</span> <span class="s2">&quot;ascii.basic&quot;</span>
<span class="n">raw_catalog</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">catalog_name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">CatsimCatalog</span><span class="p">(</span><span class="n">raw_catalog</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>When the <code class="docutils literal notranslate"><span class="pre">Catalog</span></code> object is created, it internally creates a <code class="docutils literal notranslate"><span class="pre">table</span></code> attribute containing a modified table from the input, which will be used in the rest of the code.</p>
</div>
<div class="section" id="sampling-function">
<h4>Sampling Function<a class="headerlink" href="#sampling-function" title="Permalink to this headline">¶</a></h4>
<p>The sampling function is an object which is used to determine the informations about the blends:
which galaxies are drawn, with what shifts, etc. This is achieved using the <code class="docutils literal notranslate"><span class="pre">SamplingFunction</span></code> class, which is callable like a function, taking as argument the <code class="docutils literal notranslate"><span class="pre">Catalog.table</span></code> and returning modified selected entries corresponding to the galaxies being drawn. For this tutorial, we will use the default sampling function, which can be instantiated like this:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stamp_size</span> <span class="o">=</span> <span class="mf">24.0</span>  <span class="c1"># Size of the stamp, in arcseconds</span>
<span class="n">max_number</span> <span class="o">=</span> <span class="mi">3</span>     <span class="c1"># Maximum number of galaxies in a blend</span>
<span class="n">max_shift</span> <span class="o">=</span> <span class="mf">3.0</span>    <span class="c1"># Maximum shift of the galaxies, in arcseconds</span>
<span class="n">sampling_function</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">sampling_functions</span><span class="o">.</span><span class="n">DefaultSampling</span><span class="p">(</span><span class="n">max_number</span><span class="o">=</span><span class="n">max_number</span><span class="p">,</span> <span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">,</span> <span class="n">maxshift</span><span class="o">=</span><span class="n">max_shift</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>As a reference, here is a (slightly) simplified version of the code for this sampling function:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DefaultSampling</span><span class="p">(</span><span class="n">btk</span><span class="o">.</span><span class="n">sampling_functions</span><span class="o">.</span><span class="n">SamplingFunction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default sampling function used for producing blend tables.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stamp_size</span><span class="o">=</span><span class="mf">24.0</span><span class="p">,</span> <span class="n">maxshift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            max_number (int): Defined in parent class</span>
<span class="sd">            stamp_size (float): Size of the desired stamp.</span>
<span class="sd">            maxshift (float): Magnitude of maximum value of shift. If None then it</span>
<span class="sd">                             is set as one-tenth the stamp size. (in arcseconds)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">max_number</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">=</span> <span class="n">stamp_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxshift</span> <span class="o">=</span> <span class="n">maxshift</span> <span class="k">if</span> <span class="n">maxshift</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">/</span> <span class="mf">10.0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compatible_catalogs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;CatsimCatalog&quot;</span><span class="p">,</span> <span class="s2">&quot;CosmosCatalog&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Applies default sampling to the input CatSim-like catalog and returns an</span>
<span class="sd">        astropy table with entries corresponding to a blend centered close to postage</span>
<span class="sd">        stamp center.</span>

<span class="sd">        Function selects entries from input table that are brighter than 25.3 mag</span>
<span class="sd">        in the i band. Number of objects per blend is set at a random integer</span>
<span class="sd">        between 1 and Args.max_number. The blend table is then randomly sampled</span>
<span class="sd">        entries from the table after selection cuts. The centers are randomly</span>
<span class="sd">        distributed within 1/10th of the stamp size. Here even though the galaxies</span>
<span class="sd">        are sampled from a CatSim catalog, their spatial location are not</span>
<span class="sd">        representative of real blends.</span>

<span class="sd">        Args:</span>
<span class="sd">            table (astropy.table): Table containing entries corresponding to galaxies</span>
<span class="sd">                                   from which to sample.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Astropy.table with entries corresponding to one blend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_of_objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">(</span><span class="n">q</span><span class="p">,)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ref_mag&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">25.3</span><span class="p">)</span>

        <span class="n">blend_table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">number_of_objects</span><span class="p">)]</span>
        <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x_peak</span>
        <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y_peak</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">blend_table</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Object center lies outside the stamp&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blend_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>You can see that this function chooses random galaxies (after applying a magnitude cut), computes random shifts for the galaxies and returns the entries from the table, adding two columns corresponding to the shifts.</p>
<p>You may write more complex sampling functions to have more control over how the galaxies are drawn; more examples canbe found in the <code class="docutils literal notranslate"><span class="pre">btk.sampling_functions</span></code> file.</p>
</div>
<div class="section" id="survey">
<h4>Survey<a class="headerlink" href="#survey" title="Permalink to this headline">¶</a></h4>
<p>The BTK Survey object defines the observing conditions relative to a survey. It is based on the named tuple class, and contains various parameters (eg. pixel scale, effective_area), including a list of Filter objects. The Filter class is also a named tuple, and contains information concerning a specific filter in the survey (eg. exporesure time, psf). Numerous surveys are already implemented in BTK; we will import the Rubin one for this tutorial.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Rubin</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">get_surveys</span><span class="p">(</span><span class="s2">&quot;Rubin&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>You may want to define your own survey if you wish to modify some parameters or use a survey which is not implemented in BTK. We advise you to take the code of an existing survey and modify it to your convenience. Here is the one for Rubin:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">btk.survey</span> <span class="kn">import</span> <span class="n">get_psf</span>

<span class="n">_central_wavelength</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="mf">3592.13</span><span class="p">,</span>
    <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="mf">4789.98</span><span class="p">,</span>
    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mf">6199.52</span><span class="p">,</span>
    <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="mf">7528.51</span><span class="p">,</span>
    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">8689.83</span><span class="p">,</span>
    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">9674.05</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">Rubin</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Survey</span><span class="p">(</span>
    <span class="s2">&quot;Rubin&quot;</span><span class="p">,</span>
    <span class="n">pixel_scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
    <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
    <span class="n">airmass</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">zeropoint_airmass</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.859</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">22.9</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">1680</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">26.40</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.451</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.814</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">22.3</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">2400</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">28.26</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.163</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.781</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">21.2</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">5520</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">28.10</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.748</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">20.5</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">5520</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">27.78</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.725</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">19.6</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">4800</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">27.39</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.043</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">psf</span><span class="o">=</span><span class="n">get_psf</span><span class="p">(</span>
                <span class="n">mirror_diameter</span><span class="o">=</span><span class="mf">8.36</span><span class="p">,</span>
                <span class="n">effective_area</span><span class="o">=</span><span class="mf">32.4</span><span class="p">,</span>
                <span class="n">filt_wavelength</span><span class="o">=</span><span class="n">_central_wavelength</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
                <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.703</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">sky_brightness</span><span class="o">=</span><span class="mf">18.6</span><span class="p">,</span>
            <span class="n">exp_time</span><span class="o">=</span><span class="mi">4800</span><span class="p">,</span>
            <span class="n">zeropoint</span><span class="o">=</span><span class="mf">26.56</span><span class="p">,</span>
            <span class="n">extinction</span><span class="o">=</span><span class="mf">0.138</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>Most attributes should be pretty straightforward to modify; please take a look at the <a class="reference external" href="https://lsstdesc.org/BlendingToolKit/src/btk.survey.html">API</a> for a more substantial description of the attributes. The <a class="reference external" href="https://github.com/LSSTDESC/BlendingToolKit/blob/main/notebooks/02b-custom-tutorial.ipynb">custom tutorial</a> also provides descriptions of the attributes and more information on how to customize surveys.</p>
<p>The <cite>psf</cite> attribute deserves an additionnal explanation: it corresponds to the PSF for each filter. It can be provided either directly as a Galsim model (eg <code class="docutils literal notranslate"><span class="pre">galsim.Kolmogorov(fwhm=1.5)</span></code>) or as a function returning a Galsim model, for randomization purposes. For example:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_psf</span><span class="p">():</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">1.7</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">galsim</span><span class="o">.</span><span class="n">Kolmogorov</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>You may want to use a function taking an argument to avoid rewriting the function for each filter; we advise using lambda functions to achieve this, eg <code class="docutils literal notranslate"><span class="pre">get_u_psf</span> <span class="pre">=</span> <span class="pre">lambda:</span> <span class="pre">get_custom_psf(u_band_argument)</span></code>.</p>
<p>Finally, you can use the default function <code class="docutils literal notranslate"><span class="pre">get_psf</span></code> as demonstrated in the Rubin Survey, to get a complex (not random) PSF, or use the function <code class="docutils literal notranslate"><span class="pre">get_psf_from_file(psf_dir,</span> <span class="pre">pixel_scale)</span></code> to import a PSF from a FITS file (randomly if there are more than one file in the directory provided). For more information on these functions take a look at the API.</p>
</div>
<div class="section" id="drawing-the-blends">
<h4>Drawing the blends<a class="headerlink" href="#drawing-the-blends" title="Permalink to this headline">¶</a></h4>
<p>Now that we have all the objects at our disposal, we can create the DrawBlendsGenerator. This object is a python generator, meaning it can be called with <code class="docutils literal notranslate"><span class="pre">next(generator)</span></code> to generate a new batch. It is defined for Catsim and COSMOS, and we will use the Catsim one here. We suggest you refer to the documentation for information on the additionnal parameters here.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">draw_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">draw_blends</span><span class="o">.</span><span class="n">CatsimGenerator</span><span class="p">(</span>
    <span class="n">catalog</span><span class="p">,</span>
    <span class="n">sampling_function</span><span class="p">,</span>
    <span class="p">[</span><span class="n">Rubin</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">,</span>
    <span class="n">cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">add_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>The results from the <code class="docutils literal notranslate"><span class="pre">next</span></code> call are stored in the dictionnary; the keys are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">blend_images</span></code> for the actual images (as a (batch_size,stamp_size,stamp_size,len(survey.filters))-sized numpy array )</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">isolated_images</span></code> for the isolated images (as a (batch_size,sampling_function.max_number,stamp_size,stamp_size,len(survey.filters))-sized numpy array )</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">blend_list</span></code> for the blend information (as a list of astropy tables corresponding to the output of the sampling function for each blend)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">psf</span></code> for the PSF (as a list of Galsim object)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wcs</span></code> for the World Coordinate System corresponding to the images (as a list of astropy.wcs.WCS objects)</p></li>
</ul>
</div></blockquote>
<p>Please note that several surveys can be provided as a list to the generator. In that case, each of the entry will contain a dictionnary indexed by the surveys, which in turn contains the results described as above (you would access it with <code class="docutils literal notranslate"><span class="pre">batch['blend_images']['LSST']</span></code> for instance.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">draw_generator</span><span class="p">)</span>
<span class="n">blend_images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_images&#39;</span><span class="p">]</span>
<span class="n">blend_list</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_list&#39;</span><span class="p">]</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_blends</span><span class="p">(</span><span class="n">blend_images</span><span class="p">,</span> <span class="n">blend_list</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">90</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_10_0.png" src="_images/tutorials_10_0.png" />
<img alt="_images/tutorials_10_1.png" src="_images/tutorials_10_1.png" />
<img alt="_images/tutorials_10_2.png" src="_images/tutorials_10_2.png" />
<img alt="_images/tutorials_10_3.png" src="_images/tutorials_10_3.png" />
<img alt="_images/tutorials_10_4.png" src="_images/tutorials_10_4.png" />
<img alt="_images/tutorials_10_5.png" src="_images/tutorials_10_5.png" />
<img alt="_images/tutorials_10_6.png" src="_images/tutorials_10_6.png" />
<img alt="_images/tutorials_10_7.png" src="_images/tutorials_10_7.png" />
</div>
</div>
</div>
<div class="section" id="measurement">
<h4>Measurement<a class="headerlink" href="#measurement" title="Permalink to this headline">¶</a></h4>
<p>Now that we have some images, we can carry on with the measurements. BTK can handle the following three main targets of deblending:</p>
<blockquote>
<div><ul class="simple">
<li><p>detections</p></li>
<li><p>segmentations</p></li>
<li><p>deblended images.</p></li>
</ul>
</div></blockquote>
<p>You can use BTK to directly carry out the measurements on the generated data. To do this, you need to define a measure function. The measure function is a regular function with two positional arguments: <code class="docutils literal notranslate"><span class="pre">batch</span></code> and <code class="docutils literal notranslate"><span class="pre">idx</span></code>. Batch is the direct output of a <code class="docutils literal notranslate"><span class="pre">DrawBlendsGenerator</span></code>, and <code class="docutils literal notranslate"><span class="pre">idx</span></code> is the index of the blend on which the measurements should be done. It also takes an arbitrary number of keyword arguments via <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code>. Here is an example of what the function looks like for SEP (python implementation of Source Extractor).</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sep_measure</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">channels_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">surveys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_noise</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Return detection, segmentation and deblending information with SEP.</span>

<span class="sd">  For each potentially multi-band image, an average over the bands is taken before measurement.</span>
<span class="sd">  NOTE: If this function is used with the multiresolution feature,</span>
<span class="sd">  measurements will be carried on the first survey, and deblended images</span>
<span class="sd">  or segmentations will not be returned.</span>

<span class="sd">  Args:</span>
<span class="sd">      batch (dict): Output of DrawBlendsGenerator object&#39;s `__next__` method.</span>
<span class="sd">      idx (int): Index number of blend scene in the batch to preform</span>
<span class="sd">          measurement on.</span>
<span class="sd">      sigma_noise (float): Sigma threshold for detection against noise.</span>

<span class="sd">  Returns:</span>
<span class="sd">      dict with the centers of sources detected by SEP detection algorithm.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">channel_indx</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">channels_last</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

  <span class="c1"># multiresolution</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;blend_images&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">surveys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;surveys are required in order to use the MR feature.&quot;</span><span class="p">)</span>
      <span class="n">survey_name</span> <span class="o">=</span> <span class="n">surveys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
      <span class="n">image</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;blend_images&quot;</span><span class="p">][</span><span class="n">survey_name</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
      <span class="n">avg_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">channel_indx</span><span class="p">)</span>
      <span class="n">wcs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;wcs&quot;</span><span class="p">][</span><span class="n">survey_name</span><span class="p">]</span>

  <span class="c1"># single-survey</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="n">image</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;blend_images&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
      <span class="n">avg_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">channel_indx</span><span class="p">)</span>
      <span class="n">wcs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;wcs&quot;</span><span class="p">]</span>

  <span class="n">stamp_size</span> <span class="o">=</span> <span class="n">avg_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">avg_image</span><span class="p">)</span>
  <span class="n">catalog</span><span class="p">,</span> <span class="n">segmentation</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
      <span class="n">avg_image</span><span class="p">,</span> <span class="n">sigma_noise</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">bkg</span><span class="o">.</span><span class="n">globalrms</span><span class="p">,</span> <span class="n">segmentation_map</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span>

  <span class="n">n_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>
  <span class="n">segmentation_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_objects</span><span class="p">,</span> <span class="n">stamp_size</span><span class="p">,</span> <span class="n">stamp_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
  <span class="n">deblended_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_objects</span><span class="p">,</span> <span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_objects</span><span class="p">):</span>
      <span class="n">seg_i</span> <span class="o">=</span> <span class="n">segmentation</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">segmentation_exp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_i</span>
      <span class="n">seg_i_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">stamp_size</span><span class="p">,</span> <span class="n">stamp_size</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
          <span class="n">seg_i_reshaped</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_i</span>
      <span class="n">seg_i_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">seg_i_reshaped</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
      <span class="n">deblended_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span> <span class="n">seg_i_reshaped</span>

  <span class="n">t</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">()</span>
  <span class="n">t</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">pixel_to_world_values</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>

  <span class="c1"># If multiresolution, return only the catalog</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;blend_images&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;catalog&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">}</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">{</span>
          <span class="s2">&quot;catalog&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
          <span class="s2">&quot;segmentation&quot;</span><span class="p">:</span> <span class="n">segmentation_exp</span><span class="p">,</span>
          <span class="s2">&quot;deblended_images&quot;</span><span class="p">:</span> <span class="n">deblended_images</span><span class="p">,</span>
      <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>The function is not required to output all three measurements, only the catalog with <code class="docutils literal notranslate"><span class="pre">ra,</span> <span class="pre">dec</span></code> columns containing the detections is mandatory. Note that in the example above the <code class="docutils literal notranslate"><span class="pre">batch</span></code> also contains the <code class="docutils literal notranslate"><span class="pre">wcs</span></code> information so it’s easy to convert between pixel and sky coordinates. Once the measure function is defined, it can be given to a <code class="docutils literal notranslate"><span class="pre">MeasureGenerator</span></code> together with the <code class="docutils literal notranslate"><span class="pre">DrawBlendsGenerator</span></code> from the previous step.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meas_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">MeasureGenerator</span><span class="p">(</span><span class="n">btk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">sep_measure</span><span class="p">,</span><span class="n">draw_generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>The results returned by the <code class="docutils literal notranslate"><span class="pre">MeasureGenerator</span></code> are both the results from the <code class="docutils literal notranslate"><span class="pre">DrawBlendsGenerator</span></code> and the measures, as a dictionnary with the same keys as the measure function output but containing a list with the results from all the blends.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">blend_results</span><span class="p">,</span> <span class="n">meas_results</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">meas_generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</div>
<div class="section" id="metrics">
<h4>Metrics<a class="headerlink" href="#metrics" title="Permalink to this headline">¶</a></h4>
<p>Finally, now that we have the measurements, we can compute metrics to evaluate the performance of those measurements. This is done using a <code class="docutils literal notranslate"><span class="pre">MetricsGenerator</span></code>, which takes a <code class="docutils literal notranslate"><span class="pre">MeasureGenerator</span></code> as an input, as well as a handful of parameters. It will match the true galaxies with the detected galaxies and compute metrics evaluating the quality of the detection (precision, recall, F1 score), the segmentation (Intersection over Union) and the reconstruction of the galaxy images (Mean Square Residual, Peak Signal to Noise Ratio, Structure Similarity Index, error on the target measures). You can find more details on those metrics on the metrics API <a class="reference external" href="https://lsstdesc.org/BlendingToolKit/src/btk.metrics.html">page</a>.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">btk.metrics</span>
<span class="kn">import</span> <span class="nn">btk.plot_utils</span>

<span class="n">metrics_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MetricsGenerator</span><span class="p">(</span><span class="n">meas_generator</span><span class="p">,</span>
                                                 <span class="n">target_meas</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ellipticity&quot;</span><span class="p">:</span><span class="n">btk</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">meas_ksb_ellipticity</span><span class="p">})</span>
<span class="n">blend_results</span><span class="p">,</span><span class="n">meas_results</span><span class="p">,</span><span class="n">results</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">metrics_generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>Once we got the results, we can plot them using functions found in the <code class="docutils literal notranslate"><span class="pre">plot_utils</span></code> module. While you can access all the raw data with the keys <code class="docutils literal notranslate"><span class="pre">&quot;detection&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;segmentation&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;reconstruction&quot;</span></code>, you can directly access all the segmentation and reconstruction metrics with the <code class="docutils literal notranslate"><span class="pre">&quot;galaxy_summary&quot;</span></code> key, which contains an astropy Table with all galaxies from all blends and the associated parameters and metrics.</p>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">plot_metrics_summary</span></code> to easily plot the results from the metrics.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_metrics_summary</span><span class="p">(</span><span class="n">results</span><span class="p">,</span><span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_15_0.png" src="_images/tutorials_15_0.png" />
<img alt="_images/tutorials_15_1.png" src="_images/tutorials_15_1.png" />
<img alt="_images/tutorials_15_2.png" src="_images/tutorials_15_2.png" />
</div>
</div>
<p>We can also use the matches from the metrics to plot the isolated galaxy images along with the matching deblended galaxies:</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_with_deblended</span><span class="p">(</span>
  <span class="n">blend_results</span><span class="p">[</span><span class="s2">&quot;blend_images&quot;</span><span class="p">],</span>
  <span class="n">blend_results</span><span class="p">[</span><span class="s2">&quot;isolated_images&quot;</span><span class="p">],</span>
  <span class="n">blend_results</span><span class="p">[</span><span class="s2">&quot;blend_list&quot;</span><span class="p">],</span>
  <span class="n">meas_results</span><span class="p">[</span><span class="s2">&quot;catalog&quot;</span><span class="p">][</span><span class="s2">&quot;sep_measure&quot;</span><span class="p">],</span>
  <span class="n">meas_results</span><span class="p">[</span><span class="s2">&quot;deblended_images&quot;</span><span class="p">][</span><span class="s2">&quot;sep_measure&quot;</span><span class="p">],</span>
  <span class="n">results</span><span class="p">[</span><span class="s2">&quot;matches&quot;</span><span class="p">][</span><span class="s2">&quot;sep_measure&quot;</span><span class="p">],</span>
  <span class="n">indexes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)),</span>
  <span class="n">band_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_16_0.png" src="_images/tutorials_16_0.png" />
<img alt="_images/tutorials_16_1.png" src="_images/tutorials_16_1.png" />
<img alt="_images/tutorials_16_2.png" src="_images/tutorials_16_2.png" />
<img alt="_images/tutorials_16_3.png" src="_images/tutorials_16_3.png" />
<img alt="_images/tutorials_16_4.png" src="_images/tutorials_16_4.png" />
</div>
</div>
</div>
<div class="section" id="saving-the-results">
<h4>Saving the results<a class="headerlink" href="#saving-the-results" title="Permalink to this headline">¶</a></h4>
<p>You may wish to save the results of a run of BTK for later use; or use BTK from the command line (see <a class="reference external" href="https://lsstdesc.org/BlendingToolKit/cli.html">documentation</a>) and retrieve the results in a python file later. Here we will show how to save and load the results.</p>
<p>Saving the results can be automatically achieved by providing the save_path argument to the three generators. It can either be a string or use the os.path API. The folder designated by the path must already exist.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">save_path</span> <span class="o">=</span> <span class="s2">&quot;/path/to/folder&quot;</span>

<span class="n">draw_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">draw_blends</span><span class="o">.</span><span class="n">CatsimGenerator</span><span class="p">(</span>
    <span class="n">catalog</span><span class="p">,</span>
    <span class="n">sampling_function</span><span class="p">,</span>
    <span class="n">Rubin</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">,</span>
    <span class="n">cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">add_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span>
<span class="p">)</span>
<span class="n">meas_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">MeasureGenerator</span><span class="p">(</span><span class="n">btk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">sep_measure</span><span class="p">,</span><span class="n">draw_generator</span><span class="p">,</span><span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">)</span>
<span class="n">metrics_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MetricsGenerator</span><span class="p">(</span><span class="n">meas_generator</span><span class="p">,</span>
                                                 <span class="n">target_meas</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ellipticity&quot;</span><span class="p">:</span><span class="n">btk</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">meas_ksb_ellipticity</span><span class="p">},</span>
                                                 <span class="n">meas_band_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                 <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">)</span>
<span class="n">blend_results</span><span class="p">,</span><span class="n">meas_results</span><span class="p">,</span><span class="n">results</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">metrics_generator</span><span class="p">)</span>
</pre></div>
</div>
<p>To load the results, you can use the <cite>load_all_results</cite> function ; you need to provide it with the name of the surveys and of the measure functions you used when saving the images, as well as the size of the batch.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">blend_results</span><span class="p">,</span><span class="n">meas_results</span><span class="p">,</span><span class="n">results</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">load_all_results</span><span class="p">(</span><span class="n">save_path</span><span class="p">,[</span><span class="s2">&quot;Rubin&quot;</span><span class="p">],[</span><span class="s2">&quot;sep_measure&quot;</span><span class="p">],</span><span class="n">n_batch</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="using-cosmos-galaxies">
<h2>Using COSMOS galaxies<a class="headerlink" href="#using-cosmos-galaxies" title="Permalink to this headline">¶</a></h2>
<p>In this section we will demonstrate how to generate blends using galaxies from the COSMOS catalog. You will find that generating images with COSMOS is very similar to generating images with Catsim.</p>
<p>Let’s start with the catalog and sampling function. We use a small sample of the real COSMOS catalog that is already in the BTK repository, but you can fill in a different path if you have the complete data set on your computer. It can be downloaded from <a class="reference external" href="https://zenodo.org/record/3242143">at this page</a>.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COSMOS_CATALOG_PATHS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;../data/cosmos/real_galaxy_catalog_23.5_example.fits&quot;</span><span class="p">,</span>
    <span class="s2">&quot;../data/cosmos/real_galaxy_catalog_23.5_example_fits.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">stamp_size</span> <span class="o">=</span> <span class="mf">24.0</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">CosmosCatalog</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">COSMOS_CATALOG_PATHS</span><span class="p">)</span>
<span class="n">sampling_function</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">sampling_functions</span><span class="o">.</span><span class="n">DefaultSampling</span><span class="p">(</span><span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>We can now create the corresponding instance of <code class="docutils literal notranslate"><span class="pre">DrawBlendsGenerator</span></code>. There is an important caveat here: as in the other tutorial, we use the Rubin survey. However, the COSMOS data set only contains images and magnitudes from the f814w band; thus, when simulating images, the same magnitude is used to compute the galaxy fluxes across all bands. The section that follows explains how to get around this issue.</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">draw_generator</span> <span class="o">=</span> <span class="n">btk</span><span class="o">.</span><span class="n">draw_blends</span><span class="o">.</span><span class="n">CosmosGenerator</span><span class="p">(</span>
        <span class="n">catalog</span><span class="p">,</span>
        <span class="n">sampling_function</span><span class="p">,</span>
        <span class="n">btk</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">get_surveys</span><span class="p">(</span><span class="s2">&quot;Rubin&quot;</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">,</span>
        <span class="n">cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">add_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">draw_generator</span><span class="p">)</span>
<span class="n">blend_images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_images&#39;</span><span class="p">]</span>
<span class="n">blend_list</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;blend_list&#39;</span><span class="p">]</span>
<span class="n">btk</span><span class="o">.</span><span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_blends</span><span class="p">(</span><span class="n">blend_images</span><span class="p">,</span> <span class="n">blend_list</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">90</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/tutorials_19_0.png" src="_images/tutorials_19_0.png" />
<img alt="_images/tutorials_19_1.png" src="_images/tutorials_19_1.png" />
<img alt="_images/tutorials_19_2.png" src="_images/tutorials_19_2.png" />
<img alt="_images/tutorials_19_3.png" src="_images/tutorials_19_3.png" />
<img alt="_images/tutorials_19_4.png" src="_images/tutorials_19_4.png" />
<img alt="_images/tutorials_19_5.png" src="_images/tutorials_19_5.png" />
<img alt="_images/tutorials_19_6.png" src="_images/tutorials_19_6.png" />
<img alt="_images/tutorials_19_7.png" src="_images/tutorials_19_7.png" />
</div>
</div>
<div class="section" id="using-different-magnitudes-for-each-band">
<h3>Using different magnitudes for each band<a class="headerlink" href="#using-different-magnitudes-for-each-band" title="Permalink to this headline">¶</a></h3>
<p>In order to circumvent the aforementioned caveat, BTK offers the possibility to retrieve different magnitudes for each band. In order to use this feature, the corresponding magnitudes can be specified in any of the two provided COSMOS catalogs using the following column name format: <code class="docutils literal notranslate"><span class="pre">&quot;sn_fn&quot;</span></code>, where <code class="docutils literal notranslate"><span class="pre">sn</span></code> and <code class="docutils literal notranslate"><span class="pre">fn</span></code> are the Survey and Filter names, respectively, as written in the <code class="docutils literal notranslate"><span class="pre">Survey</span></code> and <code class="docutils literal notranslate"><span class="pre">Filter</span></code> named tuple classes. BTK will automatically look for those columns and use the information when available to compute galaxy fluxes.</p>
</div>
<div class="section" id="more-information-about-the-cosmos-catalog">
<h3>More information about the COSMOS catalog<a class="headerlink" href="#more-information-about-the-cosmos-catalog" title="Permalink to this headline">¶</a></h3>
<p>To go a little bit deeper about providing custom COSMOS data to BTK, let’s review in more details in what the COSMOS data set and its BTK implementation consists of.</p>
<p>As seen above, the BTK <code class="docutils literal notranslate"><span class="pre">CosmosCatalog</span></code> is instantiated from two COSMOS catalogs. The first one contains all the necessary information to draw a galaxy (such as the paths to the galaxy and PSF stamps or the noise characteristics). The second one contains information about parameters fits to the galaxies (such as sersic parameters or bulge-to-disk ratios). You can refer to the README coming with the COSMOS data set <a class="reference external" href="https://zenodo.org/record/3242143">download</a> to check the column details of each catalog.</p>
<p>Internally, BTK uses galsim to draw the galaxies. In particular, it instantiates a <code class="docutils literal notranslate"><span class="pre">galsim.COSMOSCatalog</span></code>, that requires both catalogs. Yet, this object enables galsim to draw galaxies in two different modes that do not use the two catalogs in the same way: the parametric mode uses information of the second catalog while the ‘real’ mode uses information of the first catalog (and the actual galaxy and PSF stamps). You can refer to the galsim <a class="reference external" href="https://galsim-developers.github.io/GalSim/_build/html/real_gal.html">documentation</a> for more details. In BTK, we use only the ‘real’ drawing mode, so that the information of the second catalog is not necessary, even if the file must exist to instantiate the <code class="docutils literal notranslate"><span class="pre">CosmosCatalog</span></code> and <code class="docutils literal notranslate"><span class="pre">galsim.COSMOSCatalog</span></code> objects.
However, BTK still retrieves the <code class="docutils literal notranslate"><span class="pre">flux_radius</span></code> information from this catalog, in order to compute an estimate of the size of each source and to measure deblending performance depending on the source sizes. Thus, the following conditions must be satisfied when providing custom COSMOS data to BTK:</p>
<ol class="arabic simple">
<li><p>The second catalog should contain at least the <code class="docutils literal notranslate"><span class="pre">flux_radius</span></code> column,</p></li>
<li><p>The first catalog should contain the same columns than the official COSMOS data release</p></li>
<li><p>The galaxy and PSF stamps should be provided and accessible.</p></li>
<li><p>(optional) One of the two catalogs can contain multiband magnitudes using the format just described.</p></li>
</ol>
</div>
</div>
<div class="section" id="galsim-hub-tutorial">
<h2>Galsim_Hub tutorial<a class="headerlink" href="#galsim-hub-tutorial" title="Permalink to this headline">¶</a></h2>
<p>BTK supports galaxy image generation with <code class="docutils literal notranslate"><span class="pre">galsim_hub</span></code>; please refer to <a class="reference external" href="https://github.com/McWilliamsCenter/galsim_hub">this page</a> for more details on <code class="docutils literal notranslate"><span class="pre">galsim_hub</span></code>. Please note that <code class="docutils literal notranslate"><span class="pre">galsim_hub</span></code> only works with <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">3.7</span></code>.</p>
<p>The steps for using the galsim_hub generation are very similar to those from the previous section. Before starting this tutorial, you must install <code class="docutils literal notranslate"><span class="pre">galsim_hub</span></code>, which can be done using pip.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">galsim_hub</span>
</pre></div>
</div>
<p>Alternatively, you can optionally install <code class="docutils literal notranslate"><span class="pre">galsim_hub</span></code> along with BTK:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">btk</span><span class="p">[</span><span class="n">galsim</span><span class="o">-</span><span class="n">hub</span><span class="p">]</span>
</pre></div>
</div>
<p>You can find a notebook version of this tutorial in this <a class="reference external" href="https://github.com/LSSTDESC/BlendingToolKit/blob/main/notebooks/01c-galsim_hub_tutorial.ipynb">link</a>.</p>
</div>
<div class="section" id="scarlet-implementation">
<h2>SCARLET implementation<a class="headerlink" href="#scarlet-implementation" title="Permalink to this headline">¶</a></h2>
<p>We provide an implementation of the measure function for <a class="reference external" href="https://www.sciencedirect.com/science/article/abs/pii/S2213133718300301">SCARLET</a> , a deblending algorithm based on matrix factorization. The code for SCARLET can be found in this <a class="reference external" href="https://github.com/pmelchior/scarlet">repo</a>. You can install scarlet and its dependencies directly along BTK by running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">btk</span><span class="p">[</span><span class="n">scarlet</span><span class="p">]</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">pmelchior</span><span class="o">/</span><span class="n">scarlet</span>
</pre></div>
</div>
<p>This will install the latest version of SCARLET in github and NOT in pip (which is outdated).</p>
<p>You can find the SCARLET measure function implementation <a class="reference external" href="https://github.com/LSSTDESC/BlendingToolKit/blob/main/notebooks/01b-scarlet-measure.ipynb">here</a>.</p>
</div>
<div class="section" id="advanced-features">
<h2>Advanced features<a class="headerlink" href="#advanced-features" title="Permalink to this headline">¶</a></h2>
<p>You can find more details on specific features of BTK in these two tutorials: <a class="reference external" href="https://github.com/LSSTDESC/BlendingToolKit/blob/main/notebooks/02b-custom-tutorial.ipynb">the first one</a> explains how to write your own sampling function, survey or measure function (the measure function may be particularily important for users who want to test their own algorithm. <a class="reference external" href="https://github.com/LSSTDESC/BlendingToolKit/blob/main/notebooks/02a-multi-tutorial.ipynb">The second one</a> details how to use the multiresolution feature, as well as how to deal with multiple measure functions and how to pass them several different arguments using the “measure_kwargs”.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cli.html" class="btn btn-neutral float-right" title="Command Line Interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="user_guide.html" class="btn btn-neutral float-left" title="User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, btk developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>